{% extends "layout.html" %}

{% block title %}Write Journal{% endblock %}

{% block content %}
<div class="write-container">
    <!-- New Document Interface -->
    <div id="newDocumentInterface" class="new-document-interface">
        <div class="welcome-message">
            <h2>Ready to Write?</h2>
            <p class="subtitle">Choose how you'd like to express yourself today</p>
        </div>
        
        <div class="document-options">
            <div class="create-new-button primary" onclick="showSaveModal()">
                <div class="button-content">
                    <i class="fas fa-pen-fancy"></i>
                    <span>New Journal Entry</span>
                    <p class="description">Start writing your thoughts</p>
                </div>
                <div class="hover-effect"></div>
            </div>

            <div class="create-new-button" onclick="showJournalsList()">
                <div class="button-content">
                    <i class="fas fa-book"></i>
                    <span>Open Journals</span>
                    <p class="description">View your past entries</p>
                </div>
                <div class="hover-effect"></div>
            </div>
        </div>
        
        <div class="templates-section">
            <div class="templates-header">
                <i class="fas fa-star"></i>
                <h3>Recommended Templates</h3>
            </div>
            <div class="template-grid">
                <div class="template-card coming-soon">
                    <i class="fas fa-gratitude"></i>
                    <span>Gratitude Journal</span>
                    <div class="coming-soon-badge">Coming Soon</div>
                </div>
                <div class="template-card coming-soon">
                    <i class="fas fa-moon"></i>
                    <span>Dream Journal</span>
                    <div class="coming-soon-badge">Coming Soon</div>
                </div>
                <div class="template-card coming-soon">
                    <i class="fas fa-tasks"></i>
                    <span>Goal Journal</span>
                    <div class="coming-soon-badge">Coming Soon</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Write Modal Overlay -->
    <div id="writeModal" class="write-modal">
        <div class="write-modal-content">
            <div class="modal-header">
                <div class="modal-controls">
                    <button class="close-modal" onclick="closeWriteModal()">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="save-btn" onclick="quickSaveJournal()">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
            </div>
            <div class="side-toolbar">
                <button class="format-btn" onclick="formatText('bold')" title="Bold">
                    <i class="fas fa-bold"></i>
                </button>
                <button class="format-btn" onclick="formatText('italic')" title="Italic">
                    <i class="fas fa-italic"></i>
                </button>
                <button class="format-btn" onclick="formatText('underline')" title="Underline">
                    <i class="fas fa-underline"></i>
                </button>
                <div class="toolbar-divider"></div>
                <button class="format-btn" onclick="formatText('strikeThrough')" title="Strike Through">
                    <i class="fas fa-strikethrough"></i>
                </button>
                <!-- Add highlight button -->
                <button class="format-btn" onclick="highlightText()" title="Highlight">
                    <i class="fas fa-highlighter"></i>
                </button>
            </div>

            <!-- Update the AI Minds button onclick handler -->
            <div class="ai-minds-btn" onclick="showAiMindsPanel()">
                <i class="fas fa-brain brain-icon"></i>
            </div>

            <div class="modal-body">
                <div id="journalEntry" class="rich-editor" contenteditable="true" 
                    data-placeholder="Start journaling your thoughts and feelings here... Let your words flow freely in this safe space.">
                </div>
            </div>
            <div id="journalDetailsPanel" class="journal-details-panel">
                <button id="toggleDetailsBtn" class="toggle-details-btn" onclick="toggleDetailsPanel()">
                    <i class="fas fa-chevron-up"></i>
                </button>
                <div class="details-content">
                    <div class="detail-item">
                        <i class="fas fa-align-left"></i>
                        <span>Words: <span id="wordCount">0</span></span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-font"></i>
                        <span>Characters: <span id="charCount">0</span></span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <span>Created: <span id="creationDate"></span></span>
                    </div>             
                </div>
            </div>
        </div>
        <!-- Place this right after the write-modal-content div -->
        <div id="aiCommentBox" class="ai-comment-box">
            <div class="ai-comment-header">
                <div class="header-content">
                    <div class="mind-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="mind-name"></div>
                </div>
                <button class="ai-comment-close" onclick="hideAiComment()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="ai-comment-body">
                <div class="typing-animation">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Details Modal -->
    <div id="saveModal" class="save-details-modal">
        <div class="save-details-content">
            <div class="save-details-header">
                <h3>Journal Entry Details</h3>
                <button class="close-modal" onclick="closeSaveModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="save-details-body">
                <div class="form-group">
                    <label for="journalTitle">Title</label>
                    <input type="text" id="journalTitle" placeholder="Enter a title for your journal entry" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="journalDate">Date</label>
                    <input type="date" id="journalDate">
                </div>
                <!-- Removed mood selector section -->
            </div>
            <div class="save-details-footer">
                <button class="secondary-button" onclick="closeSaveModal()">Cancel</button>
                <button class="primary-button" onclick="saveJournalWithDetails()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Rename saveModal to confirmModal -->
    <div id="confirmModal" class="save-details-modal">
        <div class="save-details-content">
            <div class="save-details-header">
                <h3>Save Current Journal Entry?</h3>
                <button class="close-modal" onclick="closeConfirmModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="save-details-body">
                <p>Would you like to save your current journal entry before continuing?</p>
                <div class="form-group">
                    <label for="journalTitle">Title</label>
                    <input type="text" id="journalTitle" placeholder="Enter a title for your journal entry">
                </div>
                <div class="form-group">
                    <label for="journalDate">Date</label>
                    <input type="date" id="journalDate">
                </div>
            </div>
            <div class="save-details-footer">
                <button class="secondary-button" onclick="proceedWithoutSaving()">Don't Save</button>
                <button class="primary-button" onclick="saveAndProceed()">Save</button>
            </div>
        </div>
    </div>

    <!-- Replace AI Minds Modal with this new panel -->
    <div id="aiMindsPanel" class="ai-minds-panel">
        <div class="ai-minds-panel-header">
            <h3>Choose a Mind</h3>
            <button class="close-minds-panel" onclick="closeAiMindsPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="minds-grid">
            <div class="mind-option" onclick="selectMind(this, 'optimist')">
                <div class="mind-name">The Optimist</div>
                <div class="mind-description">Finds the silver lining in every reflection</div>
            </div>
            <div class="mind-option" onclick="selectMind(this, 'analyst')">
                <div class="mind-name">The Analyst</div>
                <div class="mind-description">Offers structured insights and patterns</div>
            </div>
            <div class="mind-option" onclick="selectMind(this, 'storyteller')">
                <div class="mind-name">The Storyteller</div>
                <div class="mind-description">Weaves narratives from your experiences</div>
            </div>
            <div class="mind-option" onclick="selectMind(this, 'coach')">
                <div class="mind-name">The Coach</div>
                <div class="mind-description">Guides you towards personal growth</div>
            </div>
        </div>
        <div class="minds-panel-footer">
            <button id="generateBtn" class="generate-btn" onclick="generateWithMind()" disabled>
                Generate
            </button>
        </div>
    </div>

    <!-- Add this after the AI Minds panel -->
    <div id="aiCommentBox" class="ai-comment-box">
        <div class="ai-comment-header">
            <div class="header-content">
                <div class="mind-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="mind-name"></div>
            </div>
            <button class="ai-comment-close" onclick="hideAiComment()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ai-comment-body">
            <div class="typing-animation">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    </div>

    <!-- Add this modal after existing modals -->
    <div id="journalsListModal" class="save-details-modal">
        <div class="save-details-content">
            <div class="save-details-header">
                <h3>Your Journals</h3>
                <button class="close-modal" onclick="closeJournalsListModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="save-details-body">
                <div class="journal-list-container">
                    <ul id="journalsList"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let autoSaveInterval = null;
let lastContent = '';

let ambiencePlayer = null;

function initAmbiencePlayer() {
    if (localStorage.getItem('musicEnabled') !== 'true') return;
    
    const selectedMusic = localStorage.getItem('selectedMusic') || 'nature';
    const volume = localStorage.getItem('musicVolume') || 50;
    
    // Stop any existing playback
    if (ambiencePlayer) {
        ambiencePlayer.pause();
        ambiencePlayer = null;
    }
    
    // Create new audio player
    ambiencePlayer = new Audio(`/static/music/${selectedMusic}.mp3`);
    ambiencePlayer.loop = true;
    ambiencePlayer.volume = volume / 100;
    ambiencePlayer.play();
}

function stopAmbienceMusic() {
    if (ambiencePlayer) {
        ambiencePlayer.pause();
        ambiencePlayer = null;
    }
}

function fadeOutAmbienceMusic(callback) {
    if (!ambiencePlayer) return callback?.();
    
    const fadeOutDuration = 1000; // 1 second fade
    const initialVolume = ambiencePlayer.volume;
    const fadeSteps = 20; // Number of steps in fade
    const volumeStep = initialVolume / fadeSteps;
    const stepDuration = fadeOutDuration / fadeSteps;
    
    let currentStep = 0;
    
    const fadeInterval = setInterval(() => {
        currentStep++;
        const newVolume = initialVolume - (volumeStep * currentStep);
        
        if (currentStep >= fadeSteps || newVolume <= 0) {
            clearInterval(fadeInterval);
            ambiencePlayer.pause();
            ambiencePlayer = null;
            callback?.();
        } else {
            ambiencePlayer.volume = newVolume;
        }
    }, stepDuration);
}

function quickSaveJournal() {
    const entry = document.getElementById('journalEntry').innerHTML;
    const title = document.getElementById('journalTitle').value.trim();
    const date = document.getElementById('journalDate').value.trim();
    
    fetch("/save_journal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ entry, title, date })
    })
    .then(response => response.json())
    .then(data => {
        showNotification("Journal saved successfully!");
        lastContent = entry;
    })
    .catch(error => {
        alert("Error saving: " + error);
        console.error("Save error:", error);
    });
}

function saveJournalWithDetails(isAutoSave = false, callback = null) {
    const entry = document.getElementById('journalEntry').innerHTML;
    const title = document.getElementById('journalTitle').value.trim();
    const date = document.getElementById('journalDate').value.trim();
    
    if (!title) {
        alert("Please enter a title for your journal entry.");
        return;
    }
    if (!date) {
        alert("Please select a date for your journal entry.");
        return;
    }
    
    closeSaveModal();
    showWriteModal();
    
    const journalData = {
        entry: entry,
        title: title,
        date: date
    };
    
    // Send to backend
    fetch("/save_journal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(journalData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            lastContent = entry;
            showNotification("Journal created successfully!");
            document.getElementById('journalTitle').dataset.originalFile = filename;
            if (callback) callback();
        }
    })
    .catch(error => {
        console.error("Save error:", error);
        showNotification("Error saving journal. Don't worry, you can continue writing.");
    });
}

function initEditor() {
    const editor = document.getElementById('journalEntry');
    
    // Add selection change listener to update button states
    document.addEventListener('selectionchange', function() {
        if (!editor.contains(document.getSelection().anchorNode)) return;
        
        // Update all format buttons
        const buttons = document.querySelectorAll('.format-btn');
        buttons.forEach(button => {
            const command = button.getAttribute('onclick').match(/formatText\('(.+?)'\)/)[1];
            if (document.queryCommandState(command)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    });
    
    // Update keydown handler for Enter key
    editor.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            
            // Create new paragraph with clean formatting
            const p = document.createElement('p');
            p.style.cssText = 'font-size: 16px; font-weight: normal; margin: 0.5em 0;';
            p.innerHTML = '<br>';
            
            // Insert the new paragraph
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            
            // Get the current block
            let currentBlock = range.startContainer;
            while (currentBlock && currentBlock.nodeType === 3) {
                currentBlock = currentBlock.parentNode;
            }
            
            // Insert new paragraph
            if (currentBlock && currentBlock !== editor) {
                if (currentBlock.nextSibling) {
                    editor.insertBefore(p, currentBlock.nextSibling);
                } else {
                    editor.appendChild(p);
                }
            } else {
                editor.appendChild(p);
            }
            
            // Move cursor to new paragraph and ensure clean formatting
            range.selectNodeContents(p);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Clear any existing formatting
            document.execCommand('removeFormat', false, null);
            
            // Reset format buttons
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }
    });

    // Rest of your existing editor initialization code
    editor.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            const textNode = document.createTextNode('\n');
            range.insertNode(textNode);
            range.setStartAfter(textNode);
            range.setEndAfter(textNode);
            selection.removeAllRanges();
            selection.addRange(range);
            return false;
        }
        
        // Add keyboard shortcuts for formatting
        if (e.ctrlKey || e.metaKey) {
            switch(e.key.toLowerCase()) {
                case 'b':
                    e.preventDefault();
                    formatText('bold');
                    break;
                case 'i':
                    e.preventDefault();
                    formatText('italic');
                    break;
                case 'u':
                    e.preventDefault();
                    formatText('underline');
                    break;
            }
        }
    });

    // Handle Enter key for new paragraphs
    editor.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            
            // Create new paragraph
            const p = document.createElement('p');
            p.style.cssText = 'font-size: 16px; font-weight: normal; margin: 0.5em 0;';
            p.innerHTML = '<br>';
            
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            
            // Split current block if needed
            let currentBlock = range.startContainer;
            while (currentBlock && currentBlock.nodeType === 3) {
                currentBlock = currentBlock.parentNode;
            }
            
            if (currentBlock && currentBlock !== editor) {
                // Insert after current block
                if (currentBlock.nextSibling) {
                    editor.insertBefore(p, currentBlock.nextSibling);
                } else {
                    editor.appendChild(p);
                }
            } else {
                editor.appendChild(p);
            }
            
            // Move cursor to new paragraph
            range.selectNodeContents(p);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }
    });

    // Add input event listener for stats update
    editor.addEventListener('input', updateJournalStats);
    
    // Initial stats update
    updateJournalStats();
}

window.addEventListener('load', function() {
    lastContent = document.getElementById('journalEntry').innerHTML;
    initEditor();
});

window.addEventListener('autoSaveChanged', function(e) {
    initAutoSave();
});

window.addEventListener('storage', function(e) {
    if (e.key === 'autoSave') {
        initAutoSave();
    }
});

function showWriteModal() {
    document.getElementById('writeModal').classList.add('active');
    initAmbiencePlayer();
}

function closeWriteModal() {
    const currentContent = document.getElementById('journalEntry').innerHTML;
    if (currentContent.trim() !== lastContent.trim()) {
        if (!confirm('Are you sure you want to close? Any unsaved changes will be lost.')) {
            return;
        }
    }
    
    // Fade out music and remove modal after fade completes
    fadeOutAmbienceMusic(() => {
        document.getElementById('writeModal').classList.remove('active');
        document.getElementById('journalEntry').innerHTML = '';
        lastContent = '';
    });
    hideAiComment();
}

function showSaveModal(type = 'text') {
    const saveModal = document.getElementById('saveModal');
    saveModal.classList.add('active');
    
    // Reset mood selection
    selectedMood = null;
    document.querySelectorAll('.mood-option').forEach(option => {
        option.classList.remove('active');
    });
    document.getElementById('moodError').style.display = 'none';
    
    // Store the type to know which modal to open after saving
    saveModal.dataset.nextAction = type;
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('journalDate').value = today;
    
    // Focus on title input
    document.getElementById('journalTitle').focus();
}

function closeSaveModal() {
    const saveModal = document.getElementById('saveModal');
    saveModal.classList.remove('active');
}

function formatText(command) {
    // Toggle the command state
    const isActive = document.queryCommandState(command);
    document.execCommand(command, false, null);
    
    // Update button state
    const button = document.querySelector(`.format-btn[onclick*="${command}"]`);
    if (button) {
        if (!isActive) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    }
    
    // Keep focus on editor
    const editor = document.getElementById('journalEntry');
    editor.focus();
}

function formatHeading(level) {
    const editor = document.getElementById('journalEntry');
    const selection = window.getSelection();
    
    // Make sure we're working with text in the editor
    if (!editor.contains(selection.anchorNode)) {
        editor.focus();
        return;
    }
    
    // Get the current block element containing the cursor/selection
    let currentBlock = selection.anchorNode;
    while (currentBlock && currentBlock.nodeType === 3 || !['P', 'H1', 'H2', 'DIV'].includes(currentBlock.nodeName)) {
        currentBlock = currentBlock.parentNode;
        if (currentBlock === editor) break;
    }
    
    // Create new block with desired formatting
    const newBlock = document.createElement(level);
    if (level === 'p') {
        newBlock.style.cssText = 'font-size: 16px; font-weight: normal; margin: 0.5em 0;';
    } else if (level === 'h1') {
        newBlock.style.cssText = 'font-size: 24px; font-weight: bold; margin: 1em 0 0.5em;';
    } else if (level === 'h2') {
        newBlock.style.cssText = 'font-size: 20px; font-weight: bold; margin: 1em 0 0.5em;';
    }
    
    // Handle different selection scenarios
    if (selection.toString().trim()) {
        // Text is selected - format selection
        const range = selection.getRangeAt(0);
        newBlock.appendChild(range.extractContents());
        range.insertNode(newBlock);
        
        // Clean up any empty blocks left behind
        if (currentBlock && currentBlock !== editor && currentBlock.innerHTML.trim() === '') {
            currentBlock.remove();
        }
    } else {
        // No selection - format current block or create new block
        if (currentBlock && currentBlock !== editor) {
            newBlock.innerHTML = currentBlock.innerHTML;
            currentBlock.replaceWith(newBlock);
        } else {
            newBlock.innerHTML = '<br>';
            selection.getRangeAt(0).insertNode(newBlock);
        }
    }
    
    // Place cursor at end of new block
    const range = document.createRange();
    range.selectNodeContents(newBlock);
    range.collapse(false);
    selection.removeAllRanges();
    selection.addRange(range);
    
    editor.focus();
}

function toggleDetailsPanel() {
    const panel = document.getElementById('journalDetailsPanel');
    const btn = document.getElementById('toggleDetailsBtn');
    panel.classList.toggle('expanded');
    btn.classList.toggle('expanded');
    updateJournalStats();
}

function updateJournalStats() {
    const content = document.getElementById('journalEntry');
    const text = content.innerText || '';
    
    // Update word count
    const words = text.trim().split(/\s+/).filter(word => word.length > 0);
    document.getElementById('wordCount').textContent = words.length;
    
    // Update character count
    document.getElementById('charCount').textContent = text.length;
    
    // Update paragraph count
    const paragraphs = content.getElementsByTagName('p').length || 1;
    document.getElementById('paragraphCount').textContent = paragraphs;
    
    // Set creation date if not already set
    const dateElement = document.getElementById('creationDate');
    if (!dateElement.textContent) {
        const now = new Date();
        dateElement.textContent = now.toLocaleDateString();
    }
}

function toggleMute() {
    if (!ambiencePlayer) return;
    
    const muteBtn = document.querySelector('.mute-btn i');
    
    if (ambiencePlayer.muted) {
        ambiencePlayer.muted = false;
        muteBtn.className = 'fas fa-volume-up';
    } else {
        ambiencePlayer.muted = true;
        muteBtn.className = 'fas fa-volume-mute';
    }
}

// Add these new functions
let pendingAction = null;

function confirmAndShowWriteModal() {
    if (hasUnsavedChanges()) {
        pendingAction = showWriteModal;
        showConfirmModal();
    } else {
        showWriteModal();
    }
}

function confirmAndShowVoiceModal() {
    if (hasUnsavedChanges()) {
        pendingAction = showVoiceModal;
        showConfirmModal();
    } else {
        showVoiceModal();
    }
}

function hasUnsavedChanges() {
    const currentContent = document.getElementById('journalEntry').innerHTML;
    return currentContent.trim() !== lastContent.trim();
}

function showConfirmModal() {
    const confirmModal = document.getElementById('confirmModal');
    confirmModal.classList.add('active');
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('journalDate').value = today;
    
    // Focus on title input
    document.getElementById('journalTitle').focus();
}

function closeConfirmModal() {
    const confirmModal = document.getElementById('confirmModal');
    confirmModal.classList.remove('active');
    pendingAction = null;
}

function saveAndProceed() {
    saveJournalWithDetails(false, () => {
        closeConfirmModal();
        if (pendingAction) {
            pendingAction();
            pendingAction = null;
        }
    });
}

function proceedWithoutSaving() {
    closeConfirmModal();
    if (pendingAction) {
        pendingAction();
        pendingAction = null;
    }
}

let selectedMood = null;

function selectMood(element, mood) {
    // Remove active class from all moods
    document.querySelectorAll('.mood-option').forEach(option => {
        option.classList.remove('active');
    });
    
    // Add active class to selected mood
    element.classList.add('active');
    selectedMood = mood;
    
    // Hide error message if it was shown
    document.getElementById('moodError').style.display = 'none';
}

function highlightText() {
    const selection = window.getSelection();
    
    // Only proceed if there's selected text within the editor
    if (!selection.toString().trim() || !document.getElementById('journalEntry').contains(selection.anchorNode)) {
        return;
    }
    
    // Create a span with a softer yellow background
    const span = document.createElement('span');
    span.style.backgroundColor = '#ac7f3d'; // Lighter, softer yellow
    
    // Get the selected range
    const range = selection.getRangeAt(0);
    
    // Wrap selection with our highlighted span
    range.surroundContents(span);
    
    // Keep editor focused
    document.getElementById('journalEntry').focus();
}

let selectedMindType = null;

function showAiMindsPanel() {
    const panel = document.getElementById('aiMindsPanel');
    panel.classList.add('active');
    
    // Add click outside listener
    document.addEventListener('click', handleOutsideClick);
}

function closeAiMindsPanel() {
    const panel = document.getElementById('aiMindsPanel');
    panel.classList.remove('active');
    
    // Remove click outside listener
    document.removeEventListener('click', handleOutsideClick);
}

function handleOutsideClick(e) {
    const panel = document.getElementById('aiMindsPanel');
    const aiMindsBtn = document.querySelector('.ai-minds-btn');
    
    if (!panel.contains(e.target) && !aiMindsBtn.contains(e.target)) {
        closeAiMindsPanel();
    }
}

function selectMind(element, mindType) {
    // Remove selection from all options
    document.querySelectorAll('.mind-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selection to clicked option
    element.classList.add('selected');
    
    // Enable generate button
    document.getElementById('generateBtn').disabled = false;
    
    selectedMindType = mindType;
}

// Add these mind-specific configurations
const mindConfigs = {
    optimist: {
        icon: 'fa-smile',
        response: "I noticed you're focusing a lot on progress. That's a great sign! Keep that momentum!"
    },
    analyst: {
        icon: 'fa-chart-line',
        response: "Looking at the patterns in your writing, I see some interesting insights forming. Let's explore them."
    },
    storyteller: {
        icon: 'fa-book-open',
        response: "Your narrative is unfolding beautifully. Each word adds another layer to your story."
    },
    coach: {
        icon: 'fa-trophy',
        response: "You're taking important steps forward. Let's build on this momentum and set some clear goals."
    }
};

function showAiComment(mindType, customMessage = null) {
    const commentBox = document.getElementById('aiCommentBox');
    const header = commentBox.querySelector('.mind-name');
    const icon = commentBox.querySelector('.mind-icon i');
    const body = commentBox.querySelector('.ai-comment-body');
    
    header.textContent = `The ${mindType.charAt(0).toUpperCase() + mindType.slice(1)}`;
    icon.className = `fas ${mindConfigs[mindType].icon}`;
    
    if (customMessage) {
        body.innerHTML = customMessage;
    } else {
        body.innerHTML = `
            <div class="typing-animation">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;
    }
    
    commentBox.classList.add('active');
}

function hideAiComment() {
    const commentBox = document.getElementById('aiCommentBox');
    commentBox.classList.remove('active');
}

// Update the generateWithMind function
function generateWithMind() {
    if (!selectedMindType) return;
    
    // Get current journal content
    const journalText = document.getElementById('journalEntry').innerHTML;
    
    // Clean the text (remove HTML tags)
    const cleanText = journalText.replace(/<[^>]*>?/gm, '').trim();
    
    if (!cleanText) {
        showAiComment(selectedMindType, "Write a bit more so I can understand your thoughts better.");
        return;
    }
    
    // Close the panel
    closeAiMindsPanel();
    
    // Show comment box with loading state
    const commentBox = document.getElementById('aiCommentBox');
    const header = commentBox.querySelector('.mind-name');
    const icon = commentBox.querySelector('.mind-icon i');
    const body = commentBox.querySelector('.ai-comment-body');
    
    // Configure the comment box
    header.textContent = `The ${selectedMindType.charAt(0).toUpperCase() + selectedMindType.slice(1)}`;
    icon.className = `fas ${mindConfigs[selectedMindType].icon}`;
    
    // Show typing animation
    body.innerHTML = `
        <div class="typing-animation">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    
    // Show the comment box
    commentBox.classList.add('active');
    
    // Make API call to get AI response
    fetch("/generate-mind-response", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            text: cleanText,
            mind: selectedMindType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            body.innerHTML = "I couldn't analyze that properly. Try writing a bit more.";
        } else {
            // Create container for the response
            const responseText = data.response;
            body.innerHTML = responseText;
            
            // Check if content needs truncation
            if (body.scrollHeight > 150) {
                body.classList.add('truncated');
                const readMoreBtn = document.createElement('button');
                readMoreBtn.className = 'read-more-btn';
                readMoreBtn.textContent = 'Read more...';
                readMoreBtn.onclick = function() {
                    body.classList.remove('truncated');
                    this.style.display = 'none';
                };
                body.appendChild(readMoreBtn);
            }
        }
    })
    .catch(error => {
        console.error("Error generating mind response:", error);
        body.innerHTML = "Sorry, I had trouble analyzing that. Please try again.";
    });
    
    // Reset selection
    selectedMindType = null;
    document.querySelectorAll('.mind-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.getElementById('generateBtn').disabled = true;
}

// Add minds configuration
const minds = [
    {
        id: 'optimist',
        name: 'The Optimist',
        icon: 'fa-smile',
        description: 'Finds the silver lining in every reflection',
        personality: 'Bright and encouraging',
        messageStyle: 'Always uplifting and focused on possibilities'
    },
    {
        id: 'analyst',
        name: 'The Analyst',
        icon: 'fa-chart-line',
        description: 'Offers structured insights and patterns',
        personality: 'Thoughtful and methodical',
        messageStyle: 'Clear analysis with precise observations'
    },
    {
        id: 'storyteller',
        name: 'The Storyteller',
        icon: 'fa-book-open',
        description: 'Weaves narratives from your experiences',
        personality: 'Creative and empathetic',
        messageStyle: 'Rich with metaphors and narrative elements'
    },
    {
        id: 'coach',
        name: 'The Coach',
        icon: 'fa-trophy',
        description: 'Guides you towards personal growth',
        personality: 'Motivating and action-oriented',
        messageStyle: 'Practical insights with clear next steps'
    }
];

// Update generateWithMind function to use mind configurations
function generateWithMind() {
    if (!selectedMindType) return;
    
    const selectedMind = minds.find(mind => mind.id === selectedMindType);
    if (!selectedMind) return;
    
    const journalText = document.getElementById('journalEntry').innerHTML;
    const cleanText = journalText.replace(/<[^>]*>?/gm, '').trim();
    
    if (!cleanText) {
        showAiComment(selectedMind.id, "Write a bit more so I can understand your thoughts better.");
        return;
    }
    
    closeAiMindsPanel();
    
    // Show comment box with loading state
    const commentBox = document.getElementById('aiCommentBox');
    const header = commentBox.querySelector('.mind-name');
    const icon = commentBox.querySelector('.mind-icon i');
    const body = commentBox.querySelector('.ai-comment-body');
    
    // Configure the comment box with personality
    header.textContent = selectedMind.name;
    icon.className = `fas ${selectedMind.icon}`;
    
    // Show typing animation
    body.innerHTML = `
        <div class="typing-animation">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    
    commentBox.classList.add('active');
    
    // Make API call with personality-aware prompt
    fetch("/generate-mind-response", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            text: cleanText,
            mind: selectedMind.id
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            body.innerHTML = "I couldn't analyze that properly. Try writing a bit more.";
        } else {
            body.innerHTML = data.response;
        }
    })
    .catch(error => {
        console.error("Error generating mind response:", error);
        body.innerHTML = "Sorry, I had trouble analyzing that. Please try again.";
    });
    
    // Reset selection
    selectedMindType = null;
    document.querySelectorAll('.mind-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.getElementById('generateBtn').disabled = true;
}

function showJournalsList() {
    const modal = document.getElementById('journalsListModal');
    modal.classList.add('active');
    listAvailableJournals();
}

function closeJournalsListModal() {
    const modal = document.getElementById('journalsListModal');
    modal.classList.remove('active');
}

function listAvailableJournals() {
    const list = document.getElementById('journalsList');
    list.innerHTML = '<li class="loading">Loading journals...</li>';
    
    fetch("/list_journals")
        .then(response => response.json())
        .then(data => {
            list.innerHTML = '';
            if (data.journals.length === 0) {
                list.innerHTML = '<li class="no-journals">No journals found</li>';
                return;
            }
            
            data.journals.forEach(filename => {
                const li = document.createElement('li');
                li.className = 'journal-item';
                
                // Extract date and title from filename
                const [date, ...titleParts] = filename.replace('.txt', '').split('_');
                const title = titleParts.join(' ');
                const formattedDate = new Date(date).toLocaleDateString();
                
                li.innerHTML = `
                    <div class="journal-info">
                        <span class="journal-title">${title}</span>
                        <span class="journal-date">${formattedDate}</span>
                    </div>
                    <button onclick="openJournal('${filename}')" class="open-btn">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                `;
                list.appendChild(li);
            });
        })
        .catch(error => {
            list.innerHTML = '<li class="error">Error loading journals</li>';
            console.error('Error loading journals:', error);
        });
}

function openJournal(filename) {
    closeJournalsListModal();
    
    // Load the journal content
    fetch("/load_journal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename })
    })
    .then(response => response.json())
    .then(data => {
        showWriteModal();
        
        // Extract date and title from filename
        const [date, ...titleParts] = filename.replace('.txt', '').split('_');
        const title = titleParts.join(' ');
        
        // Set the form fields
        document.getElementById('journalTitle').value = title;
        document.getElementById('journalDate').value = date;
        document.getElementById('journalEntry').innerHTML = data.entry;
        
        // Update last content to prevent unsaved changes warning
        lastContent = data.entry;
    })
    .catch(error => {
        console.error('Error loading journal:', error);
        alert('Error loading journal. Please try again.');
    });
}
</script>
{% endblock %}
